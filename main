import time
import random
from web3 import Web3
from eth_account import Account

abi = [{"inputs":[{"internalType":"address","name":"_owner","type":"address"},{"internalType":"address","name":"_judge","type":"address"},{"internalType":"address","name":"_withdrawJudge","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[],"name":"BattleAlreadyClaimed","type":"error"},{"inputs":[],"name":"BattleAlreadyMatched","type":"error"},{"inputs":[],"name":"BattleAlreadyNullified","type":"error"},{"inputs":[],"name":"BattleNotMatched","type":"error"},{"inputs":[],"name":"BattleSelfForbidden","type":"error"},{"inputs":[],"name":"ClaimFromNonParticipant","type":"error"},{"inputs":[],"name":"EthFeeNumerTooHigh","type":"error"},{"inputs":[],"name":"EthStakeMustMatchMsgValue","type":"error"},{"inputs":[],"name":"EthStakeNotUnique","type":"error"},{"inputs":[],"name":"ExceedsMaximumUniqueStakes","type":"error"},{"inputs":[],"name":"ExistingStakes","type":"error"},{"inputs":[],"name":"FeeTooLow","type":"error"},{"inputs":[],"name":"ForgedSignature","type":"error"},{"inputs":[],"name":"ForgedWithdrawSignature","type":"error"},{"inputs":[],"name":"InvalidShortString","type":"error"},{"inputs":[],"name":"MustHaveStake","type":"error"},{"inputs":[],"name":"NotAllowedParticipant","type":"error"},{"inputs":[],"name":"OnlyInitiatorCanNullify","type":"error"},{"inputs":[{"internalType":"string","name":"str","type":"string"}],"name":"StringTooLong","type":"error"},{"inputs":[],"name":"TransferFailed","type":"error"},{"inputs":[],"name":"UniqueJudge","type":"error"},{"inputs":[],"name":"UserAlreadyWithdrawn","type":"error"},{"inputs":[],"name":"WithdrawFromNonParticipant","type":"error"},{"inputs":[],"name":"ZeroAddressNotAllowed","type":"error"},{"anonymous":False,"inputs":[{"indexed":True,"internalType":"uint256","name":"battleId","type":"uint256"},{"indexed":True,"internalType":"address","name":"caller","type":"address"}],"name":"BattleCanceled","type":"event"},{"anonymous":False,"inputs":[{"indexed":True,"internalType":"uint256","name":"battleId","type":"uint256"},{"indexed":True,"internalType":"address","name":"playerOne","type":"address"},{"indexed":True,"internalType":"address","name":"playerTwo","type":"address"},{"indexed":False,"internalType":"uint256[]","name":"assetEnum","type":"uint256[]"},{"indexed":False,"internalType":"address[]","name":"contractAddr","type":"address[]"},{"indexed":False,"internalType":"uint256[]","name":"amtOrTokenId","type":"uint256[]"}],"name":"BattleInitialized","type":"event"},{"anonymous":False,"inputs":[{"indexed":True,"internalType":"uint256","name":"battleId","type":"uint256"},{"indexed":True,"internalType":"address","name":"playerOne","type":"address"},{"indexed":True,"internalType":"address","name":"playerTwo","type":"address"},{"indexed":False,"internalType":"uint256[]","name":"assetEnum","type":"uint256[]"},{"indexed":False,"internalType":"address[]","name":"contractAddr","type":"address[]"},{"indexed":False,"internalType":"uint256[]","name":"amtOrTokenId","type":"uint256[]"}],"name":"BattleJoined","type":"event"},{"anonymous":False,"inputs":[{"indexed":True,"internalType":"uint256","name":"battleId","type":"uint256"},{"indexed":True,"internalType":"address","name":"caller","type":"address"},{"indexed":True,"internalType":"address","name":"counterparty","type":"address"}],"name":"BattleNullified","type":"event"},{"anonymous":False,"inputs":[{"indexed":True,"internalType":"uint256","name":"battleId","type":"uint256"},{"indexed":True,"internalType":"address","name":"winner","type":"address"}],"name":"BattleWon","type":"event"},{"anonymous":False,"inputs":[],"name":"EIP712DomainChanged","type":"event"},{"anonymous":False,"inputs":[{"indexed":True,"internalType":"uint256","name":"ethFeeNumer","type":"uint256"}],"name":"EthFeeNumerChanged","type":"event"},{"anonymous":False,"inputs":[{"indexed":True,"internalType":"uint256","name":"feeChanged","type":"uint256"}],"name":"FeeChanged","type":"event"},{"anonymous":False,"inputs":[{"indexed":True,"internalType":"address","name":"newJudge","type":"address"}],"name":"JudgeChanged","type":"event"},{"anonymous":False,"inputs":[{"indexed":True,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":True,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":False,"inputs":[{"indexed":True,"internalType":"address","name":"newWithdrawJudge","type":"address"}],"name":"WithdrawJudgeChanged","type":"event"},{"inputs":[],"name":"BLAST","outputs":[{"internalType":"contract IBlast","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"battles","outputs":[{"internalType":"bool","name":"claimed","type":"bool"},{"internalType":"bool","name":"matched","type":"bool"},{"internalType":"bool","name":"nullified","type":"bool"},{"internalType":"uint256","name":"value","type":"uint256"},{"components":[{"internalType":"bool","name":"isWinner","type":"bool"},{"internalType":"bool","name":"hasWithdrawn","type":"bool"},{"internalType":"address","name":"user","type":"address"},{"components":[{"internalType":"enum IBatchEscrow.AssetType","name":"asset","type":"uint8"},{"internalType":"address","name":"contractAddr","type":"address"},{"internalType":"uint256","name":"amtOrTokenId","type":"uint256"}],"internalType":"struct IBatchEscrow.BatchStake[]","name":"stakes","type":"tuple[]"}],"internalType":"struct IBatchBattle.BattleParticipant","name":"one","type":"tuple"},{"components":[{"internalType":"bool","name":"isWinner","type":"bool"},{"internalType":"bool","name":"hasWithdrawn","type":"bool"},{"internalType":"address","name":"user","type":"address"},{"components":[{"internalType":"enum IBatchEscrow.AssetType","name":"asset","type":"uint8"},{"internalType":"address","name":"contractAddr","type":"address"},{"internalType":"uint256","name":"amtOrTokenId","type":"uint256"}],"internalType":"struct IBatchEscrow.BatchStake[]","name":"stakes","type":"tuple[]"}],"internalType":"struct IBatchBattle.BattleParticipant","name":"two","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"battleId","type":"uint256"}],"name":"calcEthFee","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"feeNumer","type":"uint256"}],"name":"changeEthFeeNumer","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"fee","type":"uint256"}],"name":"changeFee","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newJudge","type":"address"}],"name":"changeJudge","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newWithdrawJudge","type":"address"}],"name":"changeWithdrawJudge","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"battleId","type":"uint256"},{"internalType":"bytes","name":"signature","type":"bytes"}],"name":"claimProceeds","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"eip712Domain","outputs":[{"internalType":"bytes1","name":"fields","type":"bytes1"},{"internalType":"string","name":"name","type":"string"},{"internalType":"string","name":"version","type":"string"},{"internalType":"uint256","name":"chainId","type":"uint256"},{"internalType":"address","name":"verifyingContract","type":"address"},{"internalType":"bytes32","name":"salt","type":"bytes32"},{"internalType":"uint256[]","name":"extensions","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"battleId","type":"uint256"}],"name":"emergencyRefund","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address payable","name":"payee","type":"address"}],"name":"emergencyWithdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address payable","name":"payee","type":"address"},{"internalType":"address","name":"token","type":"address"}],"name":"emergencyWithdrawERC20","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address payable","name":"payee","type":"address"},{"internalType":"address","name":"nft","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"emergencyWithdrawERC721","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"escrowAddr","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"ethFeeNumer","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"battleId","type":"uint256"}],"name":"getBattle","outputs":[{"components":[{"internalType":"bool","name":"claimed","type":"bool"},{"internalType":"bool","name":"matched","type":"bool"},{"internalType":"bool","name":"nullified","type":"bool"},{"internalType":"uint256","name":"value","type":"uint256"},{"components":[{"internalType":"bool","name":"isWinner","type":"bool"},{"internalType":"bool","name":"hasWithdrawn","type":"bool"},{"internalType":"address","name":"user","type":"address"},{"components":[{"internalType":"enum IBatchEscrow.AssetType","name":"asset","type":"uint8"},{"internalType":"address","name":"contractAddr","type":"address"},{"internalType":"uint256","name":"amtOrTokenId","type":"uint256"}],"internalType":"struct IBatchEscrow.BatchStake[]","name":"stakes","type":"tuple[]"}],"internalType":"struct IBatchBattle.BattleParticipant","name":"one","type":"tuple"},{"components":[{"internalType":"bool","name":"isWinner","type":"bool"},{"internalType":"bool","name":"hasWithdrawn","type":"bool"},{"internalType":"address","name":"user","type":"address"},{"components":[{"internalType":"enum IBatchEscrow.AssetType","name":"asset","type":"uint8"},{"internalType":"address","name":"contractAddr","type":"address"},{"internalType":"uint256","name":"amtOrTokenId","type":"uint256"}],"internalType":"struct IBatchEscrow.BatchStake[]","name":"stakes","type":"tuple[]"}],"internalType":"struct IBatchBattle.BattleParticipant","name":"two","type":"tuple"}],"internalType":"struct IBatchBattle.Battle","name":"","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"components":[{"internalType":"uint256","name":"battleId","type":"uint256"},{"internalType":"address","name":"account","type":"address"}],"internalType":"struct IBatchBattle.Claim","name":"claim","type":"tuple"}],"name":"getClaimTypedDataHash","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"challenging","type":"address"},{"components":[{"internalType":"enum IBatchEscrow.AssetType","name":"asset","type":"uint8"},{"internalType":"address","name":"contractAddr","type":"address"},{"internalType":"uint256","name":"amtOrTokenId","type":"uint256"}],"internalType":"struct IBatchEscrow.BatchStake[]","name":"stakes","type":"tuple[]"}],"name":"initBattle","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"battleId","type":"uint256"},{"components":[{"internalType":"enum IBatchEscrow.AssetType","name":"asset","type":"uint8"},{"internalType":"address","name":"contractAddr","type":"address"},{"internalType":"uint256","name":"amtOrTokenId","type":"uint256"}],"internalType":"struct IBatchEscrow.BatchStake[]","name":"stakes","type":"tuple[]"}],"name":"joinBattle","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"judge","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"nextBattleId","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"battleId","type":"uint256"}],"name":"nullifyBattle","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"},{"internalType":"bytes","name":"","type":"bytes"}],"name":"onERC721Received","outputs":[{"internalType":"bytes4","name":"","type":"bytes4"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"withdrawFee","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"withdrawJudge","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"battleId","type":"uint256"},{"internalType":"bytes","name":"signature","type":"bytes"}],"name":"withdrawStake","outputs":[],"stateMutability":"nonpayable","type":"function"}]

battle_id = random.randint(12, 352)

contract_address = '0xC15568330926E2A6f1519992b0364ca00faf6A7A'

w3 = Web3(Web3.HTTPProvider('https://rpc.blast.io'))

def get_random_gas_limit(min_gas, max_gas):
    return random.randint(min_gas, max_gas)

def read_private_keys(filename):
    with open(filename, 'r') as file:
        private_keys = file.readlines()
    return [key.strip() for key in private_keys]

private_keys = read_private_keys('private_keys.txt')

random.shuffle(private_keys)

contract = w3.eth.contract(address=contract_address, abi=abi)

successful_accounts = []  


for private_key in private_keys:
    account = Account.from_key(private_key)
    nonce = w3.eth.get_transaction_count(account.address)
    tx = contract.functions.nullifyBattle(battle_id).build_transaction({
        'chainId': 81457,
        'gas': get_random_gas_limit(40000, 50000),
        'gasPrice': w3.eth.gas_price,
        'nonce': nonce,
    })
    
    signed_tx = w3.eth.account.sign_transaction(tx, private_key)
    tx_hash = w3.eth.send_raw_transaction(signed_tx.rawTransaction)
    
    receipt = w3.eth.wait_for_transaction_receipt(tx_hash)
    print(f"Транзакция от аккаунта {account.address} успешно отправлена и подтверждена. Hash: {tx_hash.hex()}")
    
    successful_accounts.append(account.address)

    random_delay = random.uniform(650, 1350)
    rounded_delay = round(random_delay)
    print(f"Ожидаю {rounded_delay} сек. перед следующим аккаунтом")
    time.sleep(rounded_delay)


with open('successful.txt', 'w') as file:
    for account_address in successful_accounts:
        file.write(f"{account_address}\n")
